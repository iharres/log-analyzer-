package logAnalyzer;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.util.Vector;

public class RecursiveLogTraversal {
	private File root;
	
	private RecursiveLogTraversal(File root) {
		
	}
	
	private void traverse(File dir, Vector<File> foundFiles) {
		if(dir == null || !dir.exists()) {
			return;
		}
		if(dir.isFile()) {
			String name = dir.getName().toLowerCase();
			if(name.endsWith(".log")) {
				foundFiles.add(dir);
			}
			return;			
		}
		File[] children = dir.listFiles();
		if(children == null) {
			return;
		}
		for(File child: children) {
			traverse(child,foundFiles);
		}

	}
	
	private boolean parseFile(File f, Vector<logEntry> entries) {
		boolean valid = false;
		try(BufferedReader reader  = new BufferedReader(new FileReader (f))){
			String line;
			while((line=reader.readLine()) != null) {
				logEntry entry = parseLine(line);
				if(entry != null) {
					entries.add(entry);
					valid = true;
				}
			}
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}
		return valid;
	}
	
	private logEntry parseLine(String line) {
		if(line == null || line.isEmpty()) {
			return null;
		}
		if(!line.contains("[AUTH]") || !line.contains("user=") || !line.contains("ip=") || !line.contains("status=")){
			return null;
		}
		String [] parts = line.split(" " );
		
		if(parts.length < 6) {
			return null;
		}
		
		String timeStamp = parts[0] + " " + parts[1];
		String userPart = parts[3];
		String ipParts = parts[4];
		String statusPart = parts[5];
		String user = userPart.substring("user=".length());
		String ip = ipParts.substring("ip=".length());
		String status = statusPart.substring("status=".length());
		logEntry entry = new logEntry(timeStamp, user,ip,status);
		return entry;
	}
	
	private Suspicious findUsingIp(Vector<Suspicious> list, String ip){
		for(Suspicious suspicious : list) {
			String newSuspicious = suspicious.getIp();
			if(newSuspicious.equals(ip)) {
				return suspicious;
			}
		}
		return null;
	}
	
	private Vector<Suspicious> aggregate(Vector<logEntry> entries) {
		 Vector<Suspicious> result = new Vector<>();
		 
		 for(logEntry entry : entries) {
			 if(!"FAIL".equals(entry.getStatus())) {
				 continue;
			 }
			String ip = entry.getIp();
			Suspicious sus = findUsingIp(result, ip);
			if(sus == null) {
				sus = new Suspicious(ip);
				result.add(sus);
			}
			sus.add(entry);
			
		 }
		 return result;
	}
	
	
}
